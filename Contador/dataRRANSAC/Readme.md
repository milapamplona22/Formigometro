# dataRRANSAC
Last update: 19.06.2021

Runs the multi-target tracker RRANSAC (C++). The input is a YAML (or YML) file with the detections, and the output is another YML file that should be read using dataRRANSACutils.py.

## TL;DR
- How to run:
```
./dataRRANSAC -data exampleInput.yml -M 50 -U 5 -tau_rho 0.1 -tau_T 3 -Nw 100 -ell 200 -tauR 2 -Qm 2 -Rmx 5 -Rmy 17  -display ~/IncorGDrive/LabCog/ProjetoMila-andamento/dados/videosComplicados/1_2019-04-05_06-40-00.mp4 -out test.yml
```
- Build:
```
mkdir build
cd build
cmake ..
make
```
- These parameters were manually adjusted. The input detections were obtained using a YOLOv5l. (Parameters may vary in other cases. In this particular case, the detector was quite good.)
- The Python files (*.py) are for reading the YML files generated by dataRRANSAC (C++).


## dataRRANSAC
The dataRRANSAC runs RRANSAC on a YML (OpenCV) file containing centroids. The RRANSAC parameters must be specified in the command line. The results produce another YML (OpenCV).

* Uses rransacFrameN.hpp,cpp

##### Options:
- data: input YML file
- out: output YML with the generated tracks
- outfw: output YML with the generated tracks, with information separated into paired vectors (frames, IDs, positions)
- display: (optional) video on which the RRANSAC result is displayed
- *Mandatory* RRANSAC parameters:
```
 RRANSAC params: (must have)
  -M         (int) Number of stored models
  -U,        (float) Merge threshold
  -tau_rho   (float) Good model quality threshold
  -tau_T,    (int) Minimum number of time steps needed for a good model
  -Nw,       (int) Measurement window size
  -ell,      (int) Number of RANSAC iterations
  -tauR,     (int) Inlier threshold (multiplier)
  -Qm,       (float) Q multiplier
  -Rmx,      (float) Rx multiplier
  -Rmy       (float) Ry multiplier
```
*The most reliable output currently is to use `outfw` and then read it with `dataRRANSACutils.py` using `framewiseMeans2(readTrackerResults(yml))`*


## dataRRANSACutils.py
Python function that reads the YML generated by dataRRANSAC and returns the tracks.
* Uses the YAML package. The best way to use it is by importing it into your code.
Additionally, it has a function to create a command (CLI) and run dataRRANSAC from a dictionary with parameters.

## dataRRANSACyml2pkl.py
ToDo: Converts the tracks from YML to a PKL file.
* Only kept because it has an example of how to read the YML using OpenCV.

## rransacFrameN
In the original rransac.hpp,cpp (../code/), whenever a good track is completed, it becomes available in `std::<RRANSACmodel>tracks`. However, despite knowing its trajectory, other information such as the number of frames in which it appeared, blob size, etc., is not available. To solve this, I created rransacFeats (formigometro), which inserts methods for obtaining desired features within the tracks and stores their values. However, a features class can only be specified before the RRANSAC class itself so that it can be inserted into it (I tested inserting a base class and then deriving it, but the problem was updating the valuesâ€”the iterations ended up starting and accumulating instances in memory).

In this particular case, the only actually necessary information was knowing the frame number corresponding to each position of a track. For this, I created this specific rransacFeats that accomplishes this (rransacFrameN).

## ToDo:
- Compute position averages when an ID has more than one position in the same frame.
- Standardize this for both `out` and `outfw`.
